version: 2.1
orbs:
  node: circleci/node@1.1.6
  cxflow: checkmarx-ts/cxflow@1.0.4
jobs:
  job-checkout:
    executor:
      name: node/default
    steps:
      - checkout
      - persist_to_workspace:
          root: /home/circleci 
          paths:
            - project
  job-build:
    executor:
      name: node/default
    steps:
      - attach_workspace:
          at: /home/circleci
      - node/with-cache:
          steps:
            - run: npm install
            - run: npm test
  job-scan:
    executor: cxflow/default
    steps:
      - attach_workspace:
          at: /home/circleci
      - cxflow/scan:
          preset: 'Checkmarx Default'
          version: '9.0'
          checkmarx-url: ${CX_SERVER}
          team: '/CxServer/SP/APAC/sgcxdemo'
          apply-filters: '--filter-severity=High'
          incremental: true
          break: true
          params: '--checkmarx.username=${CX_USER} --checkmarx.password=${CX_PASSWORD} --checkmarx.incremental-num-scans=5  --checkmarx.incremental-threshold=7'
          report-file: 'checkmarx.json'
      - store_artifacts:
          path: 'checkmarx.json'
          
workflows:
    version: 2
    build-and-test:
      jobs:
        - job-checkout
        - job-build:
            requires: 
              - job-checkout
        - job-scan:
            requires: 
              - job-checkout
            context: CxFlow # use usage of organization context 'Checkmarx' for environment variables
            filters:
              branches:
                only: circleci-project-setup